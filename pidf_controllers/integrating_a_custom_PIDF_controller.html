<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Integrating a Custom PID(F) Controller - The Cookbook</title>


    <!-- Custom HTML head -->

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/general.css">
    <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../highlight.css">
    <link rel="stylesheet" href="../tomorrow-night.css">
    <link rel="stylesheet" href="../ayu-highlight.css">

    <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <!-- Provide site root to javascript -->
    <script>
        var path_to_root = "../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>
    <!-- Start loading toc.js asap -->
    <script src="../toc.js"></script>
</head>
<body>
<div id="body-container">
    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script>
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) {
        }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script>
        var theme;
        try {
            theme = localStorage.getItem('mdbook-theme');
        } catch (e) {
        }
        if (theme === null || theme === undefined) {
            theme = default_theme;
        }
        const html = document.documentElement;
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add("js");
    </script>

    <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

    <!-- Hide / unhide sidebar before it is displayed -->
    <script>
        var sidebar = null;
        var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
        if (document.body.clientWidth >= 1080) {
            try {
                sidebar = localStorage.getItem('mdbook-sidebar');
            } catch (e) {
            }
            sidebar = sidebar || 'visible';
        } else {
            sidebar = 'hidden';
        }
        sidebar_toggle.checked = sidebar === 'visible';
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <!-- populated by js -->
        <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
        <noscript>
            <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
        </noscript>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle">
            <div class="sidebar-resize-indicator"></div>
        </div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
            <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky">
                <div class="left-buttons">
                    <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor"
                           title="Toggle Table of Contents" aria-label="Toggle Table of Contents"
                           aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </label>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                            aria-label="Change theme" aria-haspopup="true" aria-expanded="false"
                            aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none">
                            <button role="menuitem" class="theme" id="light">Light</button>
                        </li>
                        <li role="none">
                            <button role="menuitem" class="theme" id="rust">Rust</button>
                        </li>
                        <li role="none">
                            <button role="menuitem" class="theme" id="coal">Coal</button>
                        </li>
                        <li role="none">
                            <button role="menuitem" class="theme" id="navy">Navy</button>
                        </li>
                        <li role="none">
                            <button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                                aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                                aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                </div>

                <h1 class="menu-title">The Cookbook</h1>

                <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/dr-hextanium/cookbook/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/dr-hextanium/cookbook/tree/main/src/pidf_controllers/integrating_a_custom_PIDF_controller.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                </div>
            </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                               aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script>
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1 id="integrating-a-custom-pidf-controller"><a class="header" href="#integrating-a-custom-pidf-controller">Integrating a Custom PID(F) Controller</a></h1>
<p><em>This recipe does not cover usage for Roadrunner or Command-Based structures.</em></p>
<p><a href="https://www.ctrlaltftc.com/the-pid-controller">PID(F) controllers</a> are some of the most used controllers in FTC.
However, it can be confusing and challenging to properly integrate them into your OpModes.
This recipe will go over an example of how to integrate a PID(F) controller alongside a manual control system.</p>
<h2 id="ingredients"><a class="header" href="#ingredients">Ingredients</a></h2>
<ol>
<li>A PID or PIDF controller class (this should be a file that is something like PIDFController.java, or you may use a pre-made one from a library like FTCLib).</li>
<li>A use case for the PID(F).</li>
<li>An OpMode or LinearOpMode.</li>
</ol>
<h2 id="the-recipe"><a class="header" href="#the-recipe">The Recipe</a></h2>
<h3 id="creating-a-pidf-controller"><a class="header" href="#creating-a-pidf-controller">Creating a PID(F) Controller</a></h3>
<p>The first part of using a PID(F) controller is creating one.
To do this, we need to declare the PID(F) controller within the OpMode:</p>
<pre><code class="language-java">package org.firstinspires.ftc.teamcode;

import com.qualcomm.robotcore.eventloop.opmode.TeleOp;
import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode; // This example is for a LinearOpMode, though a similar idea applies to regular OpModes.
import org.firstinspires.ftc.teamcode.controllers.PIDController; // This may vary depending on what implementation you are using.
import org.firstinspires.ftc.teamcode.controllers.PIDFController; // This may vary depending on what implementation you are using.

@TeleOp
public class ExampleOpMode extends LinearOpMode {

    // This line creates a PIDF controller named examplePIDF that has coefficients of:
    // kP = 0
    // kI = 0
    // kD = 0
    // kF = 0
    private PIDFController examplePIDF = new PIDFController(0, 0, 0, 0);

    // This line creates a PID controller named examplePID that has coefficients of:
    // kP = 0
    // kI = 0
    // kD = 0
    private PIDController examplePID = new PIDController(0, 0, 0);

    @Override
    public void runOpMode() {
        // OpMode code goes here
    }

}
</code></pre>
<p>Now that we have our PID(F) controller, we need to use it!
One of the most common use cases for a PID(F) controller is moving a motor to a certain motor encoder position.
As an example, let's say we have a linear slide, and want to move it to 500 ticks when we press "a."
We also want to be able to move it up and down using the triggers.
The following code is for a LinearOpMode (the <code>while (opModeIsActive())</code> section would go in the <code>loop()</code> function for a OpMode):</p>
<pre><code class="language-java">

public void runOpMode() {
    // Put all of your initialization here.
    DcMotor slides = hardwareMap.dcMotor.get("slides");
    waitForStart();

    int targetPosition = 500;

    // We will use this variable to determine if we want the PIDF to run.
    boolean usePIDF = false;

    Gamepad lastGamepad1 = new Gamepad();
    Gamepad lastGamepad2 = new Gamepad();

    while (opModeIsActive()) {

        // This is a rising-edge detector that runs if and only if "a" was pressed this loop.
        if (gamepad1.a &amp;&amp; !lastGamepad1.a) {
            usePIDF = true;
        }


        if (gamepad1.left_trigger &gt; 0) {
            slides.setPower(gamepad1.left_trigger);

            // If we get any sort of manual input, turn PIDF off.
            usePIDF = false;
        } else if (gamepad1.right_trigger &gt; 0) {
            slides.setPower(gamepad1.right_trigger);

             // If we get any sort of manual input, turn PIDF off.
            usePIDF = false;
        } else if (usePIDF) {
            // Sets the slide motor power according to the PIDF output.
            slides.setPower(examplePIDF.calculate(slides.getCurrentPosition(), targetPosition));
        }

        lastGamepad1 = gamepad1;
        lastGamepad2 = gamepad2;
    }
}


</code></pre>
<p>This is a lot, so let's break it down piece by piece.
First, we initialize our slide motor, which we call <code>slides</code>.</p>
<pre><code class="language-java">DcMotor slides = hardwareMap.dcMotor.get("slides");
</code></pre>
<p>Next, we wait for the program to start and declare some variables.</p>
<pre><code class="language-java">waitForStart();

int targetPosition = 500;

// We will use this variable to determine if we want the PIDF to run.
boolean usePIDF = false;

Gamepad lastGamepad1 = new Gamepad();
Gamepad lastGamepad2 = new Gamepad();
</code></pre>
<p><code>targetPosition</code> is simply the position we want the slides to go to, which is 500.
<code>usePIDF</code> stores the state of our system, i.e. whether we want to run the PIDF or use manual control.
<code>lastGamepad1</code> and <code>lastGamepad2</code> are used for <a href="https://gm0.org/en/latest/docs/software/tutorials/gamepad.html?detector#rising-edge-detector">Rising Edge Detectors</a>.
In short, they detect when a button begins to be pressed, and ignore when it is held.</p>
<p>The next part is the while loop, which ensures that the code runs in a loop until the OpMode stops.</p>
<pre><code class="language-java">while (opModeIsActive())
</code></pre>
<p>We then use a <a href="https://gm0.org/en/latest/docs/software/tutorials/gamepad.html?detector#rising-edge-detector">Rising Edge Detector</a> to check if "a" was just pressed.
If it was, we set <code>usePIDF</code> to true to tell the program to move to the target position.</p>
<pre><code class="language-java">// This is a rising-edge detector that runs if and only if "a" was pressed this loop.
if (gamepad1.a &amp;&amp; !lastGamepad1.a) {
    usePIDF = true;
}
</code></pre>
<p>The next part is a little complicated, but the idea is that we only want to call <code>slide.setPower()</code> once, so we group all the ways it can be called together so that they can't happen at the same time.</p>
<p>First, we check if the left trigger is pressed.
If it is, we set the slide power to an appropriate value and switch to manual control mode by setting <code>usePIDF</code> to <code>false</code>.</p>
<pre><code class="language-java">if (gamepad1.left_trigger &gt; 0) {
    slides.setPower(gamepad1.left_trigger);

    // If we get any sort of manual input, turn PIDF off.
    usePIDF = false;
}
</code></pre>
<p>Next, we do the same check, but for the right trigger.</p>
<pre><code class="language-java">else if (gamepad1.right_trigger &gt; 0) {
    slides.setPower(gamepad1.right_trigger);

        // If we get any sort of manual input, turn PIDF off.
    usePIDF = false;
}
</code></pre>
<p>Note that we use <code>else</code> to only run this code if the left trigger is not pressed.
This prevents pressing both triggers at the same time from causing any issues.</p>
<p><strong>Tip:</strong> If your triggers return nonzero values even when they are not being pressed, you can increase the minimum value (the <code>0</code> in the statement <code>if (gamepad1.left_trigger &gt; 0)</code>) from <code>0</code> to something like <code>0.1</code>.</p>
<p>Finally, if there are no manual inputs, and we are in the PID(F) state, we run the PID(F).</p>
<pre><code class="language-java">else if (usePIDF) {
    // Sets the slide motor power according to the PIDF output.
    slides.setPower(examplePIDF.calculate(slides.getCurrentPosition(), targetPosition));
}
</code></pre>
<p>We also update our stored gamepads to allow the rising-edge detector to work.</p>
<pre><code class="language-java">lastGamepad1 = gamepad1;
lastGamepad2 = gamepad2;
</code></pre>
<p>This is a pretty standard way of using the PID(F) output to set a motor power.
<code>slides.getCurrentPosition()</code>, as the name implies, just returns the current slide position, in ticks.
The <a href="https://ftclib.org/"><em>FTCLib</em></a> PID(F) assumes that the first input of the function is the place where your motor is, and the second input is the place where your motor wants to be.
We will be using the <em>FTCLib</em> PID(F) syntax here for the sake of having some standard, but either way works.</p>
<p>If you've read through this entire thing, then congrats!
You should now have a fully functioning PID(F) controller that you can implement anywhere, even in conjunction with manual control.</p>
<p>Note that the example we went through is just one way PID(F)s can be used, and there are many ways to achieve this result.
Don't worry if your code doesn't look exactly like this example!</p>
<p>As an aside, the technique we used to make sure the PID(F) control and manual control did not interfere is a simple version of what's known as a <a href="https://gm0.org/en/latest/docs/software/concepts/finite-state-machines.html"><strong>Finite State Machine</strong></a>.
This idea of having multiple possible states and only running one at a time to ensure they don't interfere can be used for much more complex systems, such as controlling an entire Autonomous!</p>
<p>Best of luck with your code!</p>
<blockquote>
<p><em>This article was last modifed:<br></em>
<em>On 2024-01-20 23:42:58 -08:00<br></em>
<em>By 0verkil<br></em>
<em>See it here: <a href="https://github.com/dr-hextanium/cookbook/commit/29f2405ab4f76eb37658e43eaf0bb610211278fc"><code>29f2405ab4f76eb37658e43eaf0bb610211278fc</code></a><br></em></p>
</blockquote>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                        <a rel="prev" href="../common_ds_errors/npe_at_init/npe_at_init.html" class="mobile-nav-chapters previous"
                           title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                            <i class="fa fa-angle-left"></i>
                        </a>

                        <a rel="next prefetch" href="../pidf_controllers/syncing_two_linear_slide_motors_using_a_pidf_controller/syncing_two_linear_slide_motors_using_a_pidf_controller.html" class="mobile-nav-chapters next"
                           title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                            <i class="fa fa-angle-right"></i>
                        </a>

                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
                <a rel="prev" href="../common_ds_errors/npe_at_init/npe_at_init.html" class="nav-chapters previous" title="Previous chapter"
                   aria-label="Previous chapter" aria-keyshortcuts="Left">
                    <i class="fa fa-angle-left"></i>
                </a>

                <a rel="next prefetch" href="../pidf_controllers/syncing_two_linear_slide_motors_using_a_pidf_controller/syncing_two_linear_slide_motors_using_a_pidf_controller.html" class="nav-chapters next" title="Next chapter"
                   aria-label="Next chapter" aria-keyshortcuts="Right">
                    <i class="fa fa-angle-right"></i>
                </a>
        </nav>

    </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

    <script src="../clipboard.min.js"></script>
    <script src="../highlight.js"></script>
    <script src="../book.js"></script>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
            data-cf-beacon='{"token": "6e64e393030545a19896dcac9e462214"}'></script>
    <!-- End Cloudflare Web Analytics -->

    <script defer data-domain="cookbook.dairy.foundation" src="https://plausible.j5155.page/js/script.js"></script>

    <!-- Custom JS scripts -->


</div>
</body>
</html>
